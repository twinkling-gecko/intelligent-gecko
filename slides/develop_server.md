---
marp: true
theme: moja-gecko
---

<!-- _class: cover -->

# CI/CD を用いた検証用サーバの話

## hungry-gecko の検証環境を用意するための方針と<br />知見の共有

---

# 検証用サーバ

- featuer ブランチ単位での作業を検証するための環境
- production/staging とは切り離された、完全な機能検証のためだけの環境
- 大抵はリソースを削って安く済ましている

---

# （ローカル環境じゃ）いかんのか？

- 環境差による問題を極力減らしたい
- レビューがしんどい
  - 手元の変更を stash なりに退避してブランチ切り替える
  - 手元に pull する
  - マイグレーションとかシード流すとか諸々反映する
  - サーバ立ち上げる
  - 終わったらマイグレーションとかシードとか諸々を取り消して
    自分の作業に戻る
  - しんどい
- あと自動化したい

---

# 今回の要件

- ① CI/CD で自動化したい
- ② 学校からサブスクの金が出ねえので
  SaaS や IaaS の無料枠は本番/ステージングに温存したい
  （できれば自腹は切りたくない）
- ③ 極力本番環境に寄せて環境差は減らしたい

## 残念ながら

- ② まずこれ本番のアプリですらないのでマジで金かけたくない（最重要）
- ② と ③ は相反するので ③ を捨てる かなしいね
- 本番に寄せるならレプリケーションしたり死活監視したり冗長化したりで
  金がかかるので...

---

<!-- _class: cover -->

# ちなみに

作業中に別のブランチに切り替えたいときは git worktree が便利
手元を崩さず別ディレクトリに checkout してくれるので楽

---

# 便利ソリューション: Heroku Review App

- Heroku の Pipeline に組みっこまれた機能
- PR 駆動でレビュー用のインスタンスを立ち上げてくれる
- ただし「インスタンスが存在する限り課金が続く」
  - レビュー用なんだからどうせすぐ破棄するしいいでしょｗということっぽい
  - Free Dyno だったとしてもスリープはしない
- 実際のところそんなすぐ PR マージできるかと言われるとアレなので
  ② に反するとして今回は選択肢から除外
  - ホントは使えるとめちゃくちゃ楽なんだけど

---

# 今回の方針

- 本来は独立した複数のサーバによるスタックだが、
  （リバースプロキシ, API サーバ, 静的アセット配信サーバ, DB サーバ）
  各サーバ分 dyno を確保すると高いので無理やり単一のサーバに詰め込む
  - heroku で無理やり複数サービスを単一 dyno で提供するために
    Docker イメージに固めこむ（最近 Docker イメージでのデプロイに対応した）
  - DB は heroku のアドオンの ClearDB を使う
    （mysql 互換で 5MB の無料枠がある）
- heroku の release phase を利用して DB の migration を行う
- 検証サーバ専用のブランチを用意し、ここへマージして push することで
  専用の Dockerfile から CI/CD で自動デプロイを行う
- 多分一番工数が重いのが Docker イメージに固めるところ
  本番と乖離していて検証用にのみ使う前提で書くのでモチベ上がらんね...
